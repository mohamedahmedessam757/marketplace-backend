generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
  SUPER_ADMIN
  SUPPORT
  @@map("user_role")
}

enum StoreStatus {
  PENDING_DOCUMENTS
  PENDING_REVIEW
  ACTIVE
  SUSPENDED
  BLOCKED
  LICENSE_EXPIRED
  @@map("store_status")
}

enum OrderStatus {
  AWAITING_OFFERS
  AWAITING_PAYMENT
  PREPARATION
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  RETURNED
  DISPUTED
  RETURN_REQUESTED
  RETURN_APPROVED
  REFUNDED
  RESOLVED
  @@map("order_status")
}

enum ActorType {
  SYSTEM
  ADMIN
  CUSTOMER
  VENDOR
  @@map("actor_type")
}

enum DocType {
  CR
  LICENSE
  ID
  IBAN
  AUTH_LETTER
  @@map("doc_type")
}

model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String    @unique
  phone           String?   @unique
  passwordHash    String    @map("password_hash")
  role            UserRole  @default(CUSTOMER)
  name            String?
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz
  otpCode         String?   @map("otp_code")
  otpExpiresAt    DateTime? @map("otp_expires_at") @db.Timestamptz
  
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  // Relations
  store           Store?
  orders          Order[]
  notifications   Notification[]
  returns         ReturnRequest[]
  disputes        Dispute[]
  orderChats      OrderChat[]
  settings        UserSettings?
  avatar          String?   @map("avatar")
  
  // Security & Recovery
  recoveryStatus         String?   @map("recovery_status") // e.g., 'PENDING_REVIEW'
  withdrawalsFrozenUntil DateTime? @map("withdrawals_frozen_until") @db.Timestamptz
  lastLoginIp            String?   @map("last_login_ip")
  lastLoginDevice        String?   @map("last_login_device")
  
  accountRecoveryRequests AccountRecoveryRequest[]
  securityLogs            SecurityLog[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model UserSettings {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @unique @map("user_id") @db.Uuid
  autoTranslateChat Boolean  @default(false) @map("auto_translate_chat")
  
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @default(now()) @map("updated_at") @db.Timestamptz

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Store {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId         String      @unique @map("owner_id") @db.Uuid
  name            String
  slug            String?     @unique
  description     String?
  category        String?
  logo            String?     @map("logo")
  status          StoreStatus @default(PENDING_DOCUMENTS)
  licenseExpiry   DateTime?   @map("license_expiry") @db.Date
  balance         Decimal     @default(0) @db.Decimal(14, 2)
  rating          Decimal     @default(0) @db.Decimal(3, 2)
  
  // Location
  address         String?
  lat             Decimal?    @db.Decimal(10, 8)
  lng             Decimal?    @db.Decimal(11, 8)

  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime    @default(now()) @map("updated_at") @db.Timestamptz

  // Relations
  owner           User             @relation(fields: [ownerId], references: [id])
  documents       StoreDocument[]
  orders          Order[]
  offers          Offer[]
  orderChats      OrderChat[]
  
  @@index([status])
  @@map("stores")
}

model StoreDocument {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId        String    @map("store_id") @db.Uuid
  docType        DocType   @map("doc_type")
  fileUrl        String?   @map("file_url")
  status         String    @default("pending") // pending | approved | rejected
  rejectedReason String?   @map("rejected_reason")
  expiresAt      DateTime? @map("expires_at") @db.Date
  
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  store          Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, docType])
  @@map("store_documents")
}

model Order {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderNumber       String      @unique @map("order_number")
  customerId        String      @map("customer_id") @db.Uuid
  storeId           String?     @map("store_id") @db.Uuid
  status            OrderStatus @default(AWAITING_OFFERS)
  
  // Vehicle Details
  vehicleMake       String      @map("vehicle_make")
  vehicleModel      String      @map("vehicle_model")
  vehicleYear       Int         @map("vehicle_year") @db.SmallInt
  vin               String?
  vinImage          String?     @map("vin_image")
  
  // Part Details
  partName          String      @map("part_name")
  partDescription   String?     @map("part_description")
  partImages        Json?       @default("[]") @map("part_images")
  
  // Preferences
  conditionPref     String?     @map("condition_pref")
  warrantyPreferred Boolean?    @default(false) @map("warranty_preferred")
  requestType       String?     @map("request_type")
  shippingType      String?     @map("shipping_type")
  
  // Financials
  totalAmount       Decimal?    @map("total_amount") @db.Decimal(14, 2)
  
  // Timestamps
  offersDeadlineAt  DateTime?   @map("offers_deadline_at") @db.Timestamptz
  paymentDeadlineAt DateTime?   @map("payment_deadline_at") @db.Timestamptz
  
  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime    @default(now()) @map("updated_at") @db.Timestamptz

  // Relations
  customer          User        @relation(fields: [customerId], references: [id])
  store             Store?      @relation(fields: [storeId], references: [id])
  offers            Offer[]
  auditLogs         AuditLog[]
  parts             OrderPart[]
  returns           ReturnRequest[]
  disputes          Dispute[]
  orderChats        OrderChat[]
  
  // Active Offer Relation
  acceptedOfferId   String?     @unique @map("offer_id") @db.Uuid
  acceptedOffer     Offer?      @relation("AcceptedOffer", fields: [acceptedOfferId], references: [id])

  @@index([customerId])
  @@index([storeId])
  @@index([status])
  @@map("orders")
}

model Offer {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId      String    @map("order_id") @db.Uuid
  storeId      String    @map("store_id") @db.Uuid
  
  unitPrice    Decimal   @map("unit_price") @db.Decimal(14, 2)
  weightKg     Decimal   @map("weight_kg") @db.Decimal(8, 2)
  shippingCost Decimal   @default(0) @map("shipping_cost") @db.Decimal(14, 2)
  hasWarranty  Boolean   @default(false) @map("has_warranty")
  deliveryDays String?   @map("delivery_days")
  condition    String?
  notes        String?
  offerImage   String?   @map("offer_image")
  status       String    @default("pending") // pending | accepted | rejected
  
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  order        Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  store        Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  // Relation back to Order if accepted
  acceptedByOrder Order? @relation("AcceptedOffer")

  @@index([orderId])
  @@index([storeId])
  @@map("offers")
}

model AuditLog {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String?   @map("order_id") @db.Uuid
  action        String
  entity        String
  actorType     ActorType @map("actor_type")
  actorId       String?   @map("actor_id")
  actorName     String?   @map("actor_name")
  previousState String?   @map("previous_state")
  newState      String?   @map("new_state")
  reason        String?
  metadata      Json?
  timestamp     DateTime  @default(now()) @db.Timestamptz

  order         Order?    @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([actorId])
  @@map("audit_logs")
}

model StaticPage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug      String   @unique
  titleAr   String?  @map("title_ar")
  titleEn   String?  @map("title_en")
  contentAr String?  @map("content_ar")
  contentEn String?  @map("content_en")
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz
  
  @@map("static_pages")
}

model OrderPart {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  name        String
  description String?
  notes       String?
  images      String[] // Array of URLs
  video       String?  // URL
  quantity    Int      @default(1)

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_parts")
}

model Notification {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipientId   String   @map("recipient_id") @db.Uuid
  recipientRole String   @default("CUSTOMER") @map("recipient_role") // CUSTOMER, MERCHANT, ADMIN
  
  titleAr     String   @map("title_ar")
  titleEn     String   @map("title_en")
  messageAr   String   @map("message_ar")
  messageEn   String   @map("message_en")
  
  type        String   @default("system") // system, order, alert, promotion
  isRead      Boolean  @default(false) @map("is_read")
  link        String?  // Frontend route to redirect to
  metadata    Json?    // For related ID (e.g. { orderId: 123 })
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz

  recipient   User     @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([isRead])
  @@map("notifications")
}

// Renamed to ReturnRequest to avoid reserved keyword collision
model ReturnRequest {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String   @map("order_id") @db.Uuid
  customerId    String   @map("customer_id") @db.Uuid
  
  reason        String
  description   String?
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  evidenceFiles Json     @default("[]") @map("evidence_files") // Array of URLs

  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @map("updated_at") @db.Timestamptz

  customer      User     @relation(fields: [customerId], references: [id])
  order         Order    @relation(fields: [orderId], references: [id])

  @@map("returns")
}

model Dispute {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String   @map("order_id") @db.Uuid
  customerId    String   @map("customer_id") @db.Uuid

  reason        String
  description   String?
  status        String   @default("OPEN") // OPEN, UNDER_REVIEW, RESOLVED, CLOSED
  evidenceFiles Json     @default("[]") @map("evidence_files") // Array of URLs

  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @map("updated_at") @db.Timestamptz

  customer      User     @relation(fields: [customerId], references: [id])
  order         Order    @relation(fields: [orderId], references: [id])

  @@map("disputes")
}



model OrderChat {
  id                           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId                      String?  @map("order_id") @db.Uuid
  vendorId                     String?  @map("vendor_id") @db.Uuid // Optional for support chats
  customerId                   String   @map("customer_id") @db.Uuid
  status                       String   @default("OPEN") // OPEN, CLOSED, EXPIRED, RESOLVED (for support)
  type                         String   @default("order") // order, support
  expiryAt                     DateTime? @map("expiry_at") @db.Timestamptz // Optional for support
  
  // Role-Specific Translation Timestamps
  customerTranslationEnabledAt DateTime? @map("customer_translation_enabled_at") @db.Timestamptz
  vendorTranslationEnabledAt   DateTime? @map("vendor_translation_enabled_at") @db.Timestamptz
  adminTranslationEnabledAt    DateTime? @map("admin_translation_enabled_at") @db.Timestamptz
  
  createdAt                    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                    DateTime @default(now()) @map("updated_at") @db.Timestamptz

  messages                     OrderChatMessage[]
  
  // Relations
  order                        Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vendor                       Store?   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  customer                     User     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Modified uniqueness constraints to allow multiple support chats per order
  @@unique([orderId, vendorId, type]) 
  @@index([orderId])
  @@index([vendorId])
  @@index([customerId])
  @@index([type])
  @@map("order_chats")
}

model OrderChatMessage {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatId         String   @map("chat_id") @db.Uuid
  senderId       String   @map("sender_id") @db.Uuid
  text           String
  translatedText String?  @map("translated_text")
  isRead         Boolean  @default(false) @map("is_read")
  
  // Media Support Extensions
  mediaUrl       String?  @map("media_url")
  mediaType      String?  @map("media_type") // image, video, pdf, docx
  mediaName      String?  @map("media_name") // To display original file name for documents
  
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  
  chat           OrderChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@map("order_chat_messages")
}

model AccountRecoveryRequest {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  oldPhone        String?  @map("old_phone")
  newPhone        String   @map("new_phone")
  status          String   @default("PENDING_REVIEW") // PENDING_REVIEW, APPROVED, REJECTED
  
  // Risk Profile Snapshot
  balanceSnapshot Decimal  @default(0) @db.Decimal(14, 2)
  openOrdersCount Int      @default(0)
  disputesCount   Int      @default(0)

  // Security Metdata
  requestIp       String?  @map("request_ip")
  requestDevice   String?  @map("request_device")
  
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz
  resolvedBy      String?   @map("resolved_by") @db.Uuid // Admin ID
  
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @default(now()) @map("updated_at") @db.Timestamptz

  user            User     @relation(fields: [userId], references: [id])
  
  @@index([status])
  @@index([userId])
  @@map("account_recovery_requests")
}

model SecurityLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid // Optional, might be unauthenticated
  email       String?
  action      String   // e.g., 'RECOVERY_OTP_SENT', 'RECOVERY_FAILED', 'RECOVERY_BLOCKED'
  ipAddress   String?  @map("ip_address")
  device      String?
  isSuccess   Boolean  @map("is_success")
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  user        User?    @relation(fields: [userId], references: [id])

  @@index([email])
  @@index([ipAddress])
  @@index([action])
  @@map("security_logs")
}
